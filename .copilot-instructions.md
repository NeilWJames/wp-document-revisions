# Copilot Instructions for WP Document Revisions

> **Note**: This file provides comprehensive architectural documentation and feature information. For practical development workflow instructions (setup, build, test commands), see `.github/copilot-instructions.md`.

## Project Overview

WP Document Revisions is a comprehensive WordPress plugin that provides document management and version control functionality. It allows teams of any size to collaboratively edit files and manage their workflow within WordPress.

### Core Purpose
- Document management and version control for WordPress
- Secure file storage with unlimited revisions
- Workflow management for document collaboration
- Enterprise-grade security for sensitive documents
- Integration with WordPress authentication and permission systems

### Key Features
- Support for any file type (docs, spreadsheets, images, PDFs, etc.)
- Secure revision tracking with full audit trails
- Document check-out/check-in workflow
- Permanent, authenticated URLs for latest versions
- RSS feeds for revision notifications
- Public/private/password-protected document visibility
- Documents and revisions shortcodes
- Recently revised documents widget

## Architecture & Key Components

### File Structure
```
wp-document-revisions/
├── wp-document-revisions.php          # Main plugin file
├── includes/                          # Core plugin classes
│   ├── class-wp-document-revisions.php           # Main plugin class
│   ├── class-wp-document-revisions-admin.php     # Admin interface
│   ├── class-wp-document-revisions-front-end.php # Frontend functionality
│   ├── class-wp-document-revisions-manage-rest.php # REST API
│   ├── revision-feed.php                         # RSS feed functionality
│   └── template-functions.php                    # Template helpers
├── tests/                             # PHPUnit tests
├── docs/                              # Comprehensive documentation
├── script/                            # Development scripts
└── css/, js/, img/                    # Assets
```

### Core Classes
1. **WP_Document_Revisions** - Main plugin class, handles core functionality
2. **WP_Document_Revisions_Admin** - WordPress admin interface
3. **WP_Document_Revisions_Front_End** - Public-facing functionality
4. **WP_Document_Revisions_Manage_Rest** - REST API endpoints
5. **WP_Document_Revisions_Recently_Revised_Widget** - Dashboard widget

### WordPress Integration
- Uses custom post type `document` for storing documents
- Leverages WordPress attachments for file storage
- Integrates with WordPress user roles and capabilities
- Uses WordPress hooks and filters extensively
- Follows WordPress coding standards (WPCS)

## Development Environment

### Setup
1. **Bootstrap**: Run `script/bootstrap` to install dependencies
2. **Docker**: Use `docker-compose up` for local development environment
3. **Dependencies**: Managed via Composer for PHP packages

### Required Tools
- PHP 7.2+ (supports up to PHP 8.3)
- WordPress 4.9+
- Composer for dependency management
- PHPUnit for testing
- PHP_CodeSniffer for code standards

### Development Workflow
```bash
# Setup development environment
script/bootstrap

# Run tests and linting
script/cibuild

# Start Docker environment
docker-compose up
# Access at http://localhost:8088
```

## Coding Standards & Conventions

### WordPress Standards
- Follow WordPress Coding Standards (WPCS) strictly
- Use WordPress functions over native PHP where available
- Proper sanitization and validation for all user inputs
- Use WordPress hooks (actions/filters) for extensibility
- Follow WordPress naming conventions for functions, classes, and variables

### PHP Standards
- PSR-4 autoloading for classes
- Comprehensive PHPDoc comments for all functions and classes
- Error handling using WordPress wp_die() and wp_error()
- Use WordPress nonces for security
- Sanitize all database inputs and outputs

### Security Considerations
- **Critical**: This plugin handles file uploads and storage
- Always validate file types and sizes
- Use WordPress authentication for file access
- Hash filenames on upload for security
- Never expose direct file paths
- Implement proper capability checks
- Use WordPress nonces for all admin actions
- Sanitize all user inputs, especially file-related data

### File Naming
- Classes: `class-wp-document-revisions-*.php`
- Functions: Use WordPress naming conventions (`wp_document_revisions_*`)
- Variables: Snake case (`$document_id`, `$revision_data`)
- Constants: Upper case with underscores (`WP_DOCUMENT_REVISIONS_VERSION`)

## Testing & Quality Assurance

### Running Tests
```bash
# Run all tests
script/cibuild

# Run only PHPUnit tests
script/cibuild-phpunit

# Run only code style checks
script/cibuild-phpcs
```

### Test Structure
- Unit tests in `/tests/` directory
- Tests extend `WP_UnitTestCase` from WordPress testing framework
- Test files prefixed with `class-test-`
- Bootstrap file sets up WordPress test environment

### Code Quality
- PHP_CodeSniffer with WordPress standards
- PHPUnit for unit testing
- Coverage reporting enabled
- Continuous integration via GitHub Actions

## WordPress-Specific Considerations

### Custom Post Types
- Documents are stored as `document` post type
- Revisions use WordPress native revision system
- Custom fields store document metadata
- Attachment system for file storage

### Hooks & Filters
- Extensive use of WordPress action and filter hooks
- Custom hooks for extensibility: `document_revisions_*`
- Integration points for other plugins
- Template system hooks for theme integration

### Capabilities & Permissions
- Custom capabilities: `edit_documents`, `edit_others_documents`
- Integration with WordPress role system
- Fine-grained permission control
- Support for custom permission schemes

### Database Integration
- Uses WordPress database abstraction layer (wpdb)
- Custom database tables for enhanced functionality
- Proper database migration handling
- Supports WordPress multisite

## Important Functions & APIs

### Core Document Functions
- `get_documents()` - Retrieve documents with filtering
- `get_document_revisions()` - Get revision history
- `check_out_document()` - Lock document for editing
- `check_in_document()` - Release document lock

### Template Functions
- Available in `includes/template-functions.php`
- Theme integration helpers
- Shortcode implementations
- Widget functionality

### REST API
- Custom endpoints for document management
- Follows WordPress REST API conventions
- Proper authentication and authorization
- JSON response format

## Security Guidelines

### File Upload Security
- Validate all uploaded files
- Check file types against allowed extensions
- Scan for malicious content
- Store files outside web root when possible
- Use hashed filenames to prevent direct access

### Access Control
- Always check user capabilities before operations
- Use WordPress nonces for form submissions
- Validate and sanitize all inputs
- Implement proper file access controls
- Log security-relevant actions

### Data Protection
- Hash sensitive data
- Use WordPress encryption functions
- Implement proper backup procedures
- Support data export/import
- Follow GDPR compliance guidelines

## Contributing Guidelines

### Code Contributions
- Follow existing code style and patterns
- Add comprehensive tests for new functionality
- Update documentation for user-facing changes
- One feature/fix per pull request
- Write descriptive commit messages

### Documentation
- Update relevant documentation in `/docs/`
- Include code examples where helpful
- Document all new hooks and filters
- Update changelog for user-visible changes

### Review Process
- All code must pass automated tests
- Follow WordPress security best practices
- Consider backward compatibility
- Test with multiple WordPress versions

## Common Patterns

### Error Handling
```php
// Use WordPress error handling
if ( is_wp_error( $result ) ) {
    return $result;
}

// For user-facing errors
wp_die( __( 'Error message', 'wp-document-revisions' ) );
```

### Database Operations
```php
// Use WordPress database abstraction
global $wpdb;
$results = $wpdb->get_results( $wpdb->prepare( 
    "SELECT * FROM {$wpdb->posts} WHERE post_type = %s", 
    'document' 
) );
```

### Capability Checks
```php
// Always check capabilities
if ( ! current_user_can( 'edit_documents' ) ) {
    return new WP_Error( 'insufficient_permission', __( 'Insufficient permissions', 'wp-document-revisions' ) );
}
```

### Hook Usage
```php
// Provide extensibility points
do_action( 'document_revisions_document_uploaded', $document_id );
$allowed_types = apply_filters( 'document_revisions_allowed_file_types', $default_types );
```

## Debugging & Troubleshooting

### Debug Mode
- Enable WordPress debug mode: `WP_DEBUG = true`
- Use error_log() for debugging output
- Check WordPress debug.log file
- Use WordPress debugging plugins

### Common Issues
- File permission problems
- Upload directory configuration
- Memory limits for large files
- Plugin conflicts
- Theme compatibility issues

## Resources

### Documentation
- `/docs/` directory contains comprehensive documentation
- `docs/CONTRIBUTING.md` - Contributing guidelines
- `docs/SUPPORT.md` - Support resources
- `docs/features.md` - Feature documentation

### External Resources
- [WordPress Plugin Development](https://developer.wordpress.org/plugins/)
- [WordPress Coding Standards](https://make.wordpress.org/core/handbook/best-practices/coding-standards/)
- [WordPress Security](https://developer.wordpress.org/plugins/security/)
- [PHPUnit Documentation](https://phpunit.de/documentation.html)

## Quick Reference

### File Locations
- Main plugin file: `wp-document-revisions.php`
- Core functionality: `includes/class-wp-document-revisions.php`
- Admin interface: `includes/class-wp-document-revisions-admin.php`
- Template functions: `includes/template-functions.php`
- Tests: `tests/class-test-*.php`

### Key Constants
- `WP_DOCUMENT_REVISIONS_VERSION` - Plugin version
- `WP_DOCUMENT_REVISIONS_URL` - Plugin URL
- `WP_DOCUMENT_REVISIONS_DIR` - Plugin directory

### Important Globals
- `$wpdr` - Main plugin instance
- `$wpdb` - WordPress database object

Remember: This plugin handles sensitive documents and file uploads. Always prioritize security and follow WordPress best practices for file handling and user authentication.